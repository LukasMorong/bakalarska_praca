#include <stdint.h>
#include <stddef.h>
#include <stdlib.h>
#include <time.h>

#include <stdio.h>


#define SAMPLE_COUNT 624
#define MAX_DIGITS 10  /* Maximum digits for 32-bit integer plus null byte */

#define OUTPUT

volatile unsigned int * const UART0DR = (unsigned int *)0x101f1000;

void print_uart0(const char *s);
void print_uart0_int(int value);

void delta_compress(volatile int16_t i_samples[], volatile int16_t q_samples[]);
void delta_decompress(volatile int16_t i_samples[], volatile int16_t q_samples[]);


int c_entry(){
    //compressed
    volatile int16_t i_samples[SAMPLE_COUNT] = {23, -118, -109, -85, -31, 20, 81, 108, 140, 116, 90, 56, 5, -34, -77, -94, -123, -108, -87, -58, -6, 35, 80, 97, 129, 111, 86, 42, -15, -56, -91, -85, -91, -74, -70, -67, -32, 8, 64, 100, 121, 133, 93, 55, 4, -42, -104, -124, -123, -86, -6, 68, 88, 76, 47, 14, 0, -7, -14, -29, -34, -32, -24, -11, -15, -42, -58, -66, -28, 24, 89, 112, 116, 109, 62, 21, -27, -66, -108, -111, -105, -97, -50, -12, 33, 69, 111, 113, 111, 96, 47, 3, -50, -84, -126, -115, -85, -31, 40, 83, 104, 69, 40, 6, -3, -8, -17, -35, -60, -58, -41, -10, 4, -6, -23, -20, 17, 66, 98, 114, 77, 49, 6, -33, -80, -99, -105, -108, -78, -59, -18, 27, 90, 114, 121, 116, 70, 35, -9, -45, -87, -103, -114, -121, -71, -6, 72, 116, 128, 69, 18, -17, -24, -25, -32, -31, -34, -21, -4, 10, 8, -5, -25, -18, 19, 71, 107, 126, 79, 26, -29, -74, -113, -108, -104, -98, -62, -22, 36, 79, 119, 105, 91, 80, 43, 10, -40, -80, -107, -131, -110, -91, -29, 30, 94, 103, 94, 71, 30, 1, -25, -45, -66, -57, -39, -8, 24, 40, 25, 6, -1, 14, 41, 75, 76, 72, 37, -2, -55, -92, -121, -138, -94, -51, -5, 27, 58, 74, 96, 120, 94, 63, 24, -23, -64, -89, -110, -127, -95, -58, -2, 48, 95, 95, 80, 53, 13, -11, -30, -39, -52, -43, -27, -5, 17, 26, 28, 24, 30, 50, 60, 74, 52, 28, -9, -48, -84, -131, -130, -127, -67, -9, 51, 86, 102, 116, 94, 90, 53, 20, -26, -62, -95, -127, -113, -104, -54, -5, 55, 88, 101, 91, 39, -1, -27, -25, -18, -13, -20, -34, -29, -10, 19, 35, 40, 33, 38, 67, 76, 73, 40, -22, -91, -118, -122, -112, -66, -37, -16, 7, 36, 68, 99, 130, 106, 77, 32, -18, -62, -108, -112, -124, -90, -59, -17, 32, 71, 103, 85, 66, 20, -12, -35, -35, -28, -18, -9, -1, 8, 18, 29, 28, 30, 43, 51, 69, 57, 35, -5, -55, -99, -139, -121, -108, -58, -25, 17, 55, 91, 131, 116, 96, 68, 22, -20, -55, -87, -124, -114, -99, -73, -19, 27, 65, 90, 110, 82, 45, -5, -41, -64, -50, -28, -5, 7, 10, 12, 18, 33, 39, 42, 47, 48, 52, 51, 16, -27, -83, -114, -141, -111, -79, -38, 6, 38, 74, 91, 123, 110, 89, 52, -5, -54, -104, -111, -121, -87, -58, -31, 12, 53, 105, 106, 91, 28, -19, -48, -38, -23, -18, -18, -19, -16, 1, 26, 43, 47, 39, 17, 18, 43, 61, 52, -3, -63, -124, -121, -111, -98, -54, -8, 44, 87, 127, 115, 102, 84, 38, -4, -43, -75, -109, -108, -105, -90, -41, 4, 58, 86, 119, 100, 68, 20, -34, -62, -77, -60, -49, -24, 4, 42, 65, 64, 45, 2, -20, -6, 33, 83, 78, 39, -36, -93, -139, -119, -95, -70, -23, 18, 65, 94, 114, 130, 98, 71, 14, -34, -87, -102, -112, -117, -78, -40, 10, 49, 89, 99, 105, 96, 34, -41, -95, -105, -84, -26, 6, 16, 16, 25, 33, 44, 46, 24, 2, -4, 14, 42, 58, 15, -61, -115, -133, -124, -62, -20, 21, 55, 103, 118, 123, 111, 59, 14, -38, -72, -113, -114, -108, -92, -39, 4, 48, 73, 110, 118, 114, 84, -2, -75, -131, -105, -59, -12, 12, 22, 20, 27, 40, 36, 31, 16, -3, -12, -4, 9, 5, -26, -65, -106, -95, -78, -27, 16, 66, 90, 108, 125, 94, 64, 8, -39, -89, -98, -101, -104, -68, -34, 15, 60, 99, 101, 102, 104, 65};
    volatile int16_t q_samples[SAMPLE_COUNT] = {303, -11, -60, -116, -121, -114, -98, -53, -13, 28, 58, 95, 100, 106, 109, 66, 22, -38, -81, -124, -119, -105, -82, -36, 7, 43, 76, 115, 114, 108, 92, 38, -9, -50, -80, -115, -113, -105, -93, -42, 3, 50, 80, 115, 107, 99, 85, 40, -2, -59, -86, -105, -71, -34, 4, 26, 35, 40, 34, 36, 26, 10, -16, -41, -47, -35, -16, -30, -58, -81, -86, -39, 13, 70, 98, 118, 138, 105, 75, 18, -30, -80, -105, -118, -129, -91, -56, -7, 36, 84, 102, 118, 130, 92, 50, -12, -60, -100, -91, -72, -47, -10, 19, 35, 41, 39, 22, 5, -14, -23, -32, -28, -30, -41, -45, -53, -60, -44, -19, 25, 72, 125, 125, 110, 85, 34, 2, -30, -55, -96, -106, -114, -108, -56, -6, 52, 85, 117, 108, 97, 79, 31, -11, -58, -78, -96, -73, -46, -11, 28, 49, 54, 33, 15, 1, -5, -15, -24, -31, -34, -29, -35, -59, -67, -68, -24, 22, 74, 95, 106, 122, 96, 69, 17, -31, -81, -93, -100, -108, -85, -66, -12, 38, 93, 106, 106, 102, 71, 45, 11, -39, -89, -103, -93, -57, -5, 32, 59, 53, 45, 20, 0, -16, -19, -22, -31, -36, -40, -32, -32, -50, -58, -47, -11, 51, 111, 117, 108, 92, 49, 17, -24, -57, -86, -114, -97, -87, -50, -15, 26, 69, 99, 126, 102, 90, 50, 21, -24, -64, -98, -122, -85, -42, 11, 39, 52, 36, 24, 15, 4, -3, -7, -12, -21, -30, -36, -46, -45, -49, -47, -15, 42, 88, 117, 131, 88, 53, 15, -22, -66, -92, -113, -135, -97, -58, -9, 43, 86, 95, 98, 102, 78, 56, 28, -19, -80, -117, -137, -127, -47, 30, 103, 107, 85, 47, 6, -16, -27, -35, -46, -38, -23, -3, 6, -3, -27, -46, -42, -1, 51, 110, 115, 112, 62, 19, -28, -62, -85, -115, -105, -106, -67, -28, 22, 63, 93, 119, 99, 79, 59, 25, -6, -41, -80, -130, -124, -95, -34, 48, 107, 99, 67, 35, 7, 2, -4, -20, -46, -52, -46, -27, -6, -5, -21, -29, -17, 28, 78, 124, 105, 75, 34, -15, -57, -83, -99, -112, -89, -70, -47, -3, 43, 104, 121, 136, 94, 58, 22, -17, -47, -87, -104, -131, -107, -66, 2, 77, 118, 120, 64, 17, -12, -23, -34, -39, -44, -40, -15, 10, 17, 7, -17, -29, -12, 38, 91, 116, 118, 58, 0, -46, -83, -127, -125, -111, -86, -32, 12, 45, 74, 114, 117, 114, 92, 30, -23, -64, -88, -117, -112, -107, -88, -28, 48, 98, 122, 114, 56, 13, -20, -32, -43, -61, -54, -43, -10, 14, 28, 23, 18, 21, 32, 63, 75, 79, 63, 13, -34, -89, -105, -124, -101, -81, -55, -3, 47, 100, 110, 123, 95, 73, 45, -7, -51, -91, -94, -100, -112, -88, -56, 5, 63, 116, 107, 81, 40, -6, -36, -41, -40, -39, -26, -14, 1, 20, 38, 36, 27, 22, 24, 43, 70, 64, 43, -8, -54, -103, -112, -114, -112, -67, -22, 34, 80, 126, 122, 108, 87, 43, 8, -35, -71, -123, -129, -124, -99, -32, 25, 82, 95, 95, 55, 25, 0, -18, -24, -29, -23, -24, -20, -18, -9, 10, 25, 44, 47, 52, 62, 58, 56, 24, -17, -73, -104, -119, -122, -77, -44, -2, 25, 59, 78, 98, 117, 90, 62, 14, -27, -77, -103, -119, -128, -82, -40, 18, 56, 89, 85, 70, 49, 11, -12, -33, -37, -48, -37, -21, 7, 32, 43, 41, 25, 25, 33, 50, 72, 59, 33, -11, -63, -121, -133, -126, -103, -51, -10, 36, 69, 113, 116, 112, 102, 55, 11, -44, -84, -113, -136, -104, -81, -26, 19, 66, 89};
    

    #ifdef OUTPUT

    // for(int i = 0; i < SAMPLE_COUNT; i++){
    //     print_uart0_int(i_samples[i]);
    // }

    // print_uart0("\n");

    // for(int i = 0; i < SAMPLE_COUNT; i++){
    //     print_uart0_int(q_samples[i]);
    // }

    // print_uart0("\n");
    // print_uart0("\n");

    #endif //OUTPUT

    // delta_compress(i_samples, q_samples);

    delta_decompress(i_samples, q_samples);

    return 0;
}

void *memcpy(void *dest, const void *src, size_t n){
    for (size_t i = 0; i < n; i++)
    {
        ((char*)dest)[i] = ((char*)src)[i];
    }
}

#ifdef OUTPUT

void print_uart0_int(int value) {
    char buffer[MAX_DIGITS];
    int i = MAX_DIGITS - 1;

    /* Handle 0 explicitely, otherwise empty string is printed for 0 */
    if (value == 0) {
        *UART0DR = '0';
        *UART0DR = ',';
        *UART0DR = ' ';
        return;
    }

    /* Handle negative numbers */
    if (value < 0) {
        *UART0DR = '-';
        value = -value;
    }

    /* Fill buffer from end */
    while (value > 0 && i >= 0) {
        buffer[i--] = (value % 10) + '0';
        value /= 10;
    }

    /* Output the number */
    while (++i < MAX_DIGITS)
        *UART0DR = buffer[i];

    *UART0DR = ',';
    *UART0DR = ' ';
    
}

void print_uart0(const char *s) {
    while(*s != '\0') { /* Loop until end of string */
        *UART0DR = (unsigned int)(*s); /* Transmit char */
        s++; /* Next char */
    }
}

#endif //OUTPUT


void delta_compress(volatile int16_t i_samples[], volatile int16_t q_samples[]){
    int16_t previousI = 0;
    int16_t previousQ = 0;
    int16_t currentI;
    int16_t currentQ;

    int16_t i_result[SAMPLE_COUNT];
    int16_t q_result[SAMPLE_COUNT];

    for(int i = 0; i < SAMPLE_COUNT; i++){
        currentI = i_samples[i] - previousI;
        previousI = i_samples[i];
        i_result[i] = currentI;

        currentQ = q_samples[i] - previousQ;
        previousQ = q_samples[i];
        q_result[i] = currentQ;
    }

    #ifdef OUTPUT

    for(int i = 0; i < SAMPLE_COUNT; i++){
        print_uart0_int(i_result[i]);
    }

    print_uart0("\n");

    for(int i = 0; i < SAMPLE_COUNT; i++){
        print_uart0_int(q_result[i]);
    }

    print_uart0("\n");
    print_uart0("\n");

    #endif //OUTPUT
}


void delta_decompress(volatile int16_t i_samples[], volatile int16_t q_samples[]){
    int16_t previousI = 0;
    int16_t previousQ = 0;

    int16_t i_result[SAMPLE_COUNT];
    int16_t q_result[SAMPLE_COUNT];

    for(int i = 0; i < SAMPLE_COUNT; i++){
        previousI += i_samples[i];
        i_result[i] = previousI;

        previousQ += q_samples[i];
        q_result[i] = previousQ;
    }

    #ifdef OUTPUT

    for(int i = 0; i < SAMPLE_COUNT; i++){
        print_uart0_int(i_result[i]);
    }

    print_uart0("\n");

    for(int i = 0; i < SAMPLE_COUNT; i++){
        print_uart0_int(q_result[i]);
    }

    print_uart0("\n");
    print_uart0("\n");

    #endif //OUTPUT
}