#include <stdint.h>
#include <stddef.h>
#include <stdlib.h>
#include <time.h>

#include <stdio.h>

#define SAMPLE_COUNT 624
#define MAX_DIGITS 10  /* Maximum digits for 32-bit integer plus null byte */
#define DICT_1_SIZE 32
#define DICT_2_SIZE 16

#define OUTPUT

volatile unsigned int * const UART0DR = (unsigned int *)0x101f1000;

void print_uart0(const char *s);
void print_uart0_int(int value);

void predictive_decompress(volatile int16_t samples[], volatile int8_t ant[]);


int c_entry(){
    //compressed
    volatile int16_t i_samples[SAMPLE_COUNT] = {23, -95, -204, -289, -320, -300, -219, -111, 29, 145, 235, 291, 296, 262, 185, 91, -32, -140, -227, -285, -291, -256, -176, -79, 50, 161, 247, 289, 274, 218, 127, 42, -72, -28, 11, 29, 28, 16, -1, -9, -28, -11, -8, -9, -10, -18, -45, -75, -107, -193, -199, -131, -43, 33, 80, 94, 94, 87, 73, 44, 10, -22, -46, -57, -23, 9, 21, 22, 26, 42, 67, 79, 74, 50, 19, -15, -46, -70, -74, -61, -118, -107, -70, -24, 15, 49, 80, 96, 78, 63, 24, -15, -50, -78, -113, -143, -79, -24, 22, 37, 53, 46, 39, 31, 28, 27, 24, 18, -8, -34, -51, -50, -31, 5, 40, 86, 131, 173, 182, 184, 145, 85, 29, -25, -78, -111, -108, -105, -78, -40, -8, 31, 88, 133, 143, 146, 105, 44, -12, -60, -97, -116, -104, -110, -96, -71, -39, -6, 18, 18, -4, -27, -48, -65, -80, -76, -50, -13, 24, 44, 48, 49, 47, 49, 51, 56, 65, 77, 79, 56, 21, -20, -53, -62, -61, -51, -35, 2, 56, 108, 137, 128, 98, 62, 35, 10, -21, -56, -76, -104, -100, -70, -28, 8, 30, 17, -17, -15, -3, 15, 14, -6, -40, -66, -71, -58, -30, 0, 17, 28, 52, 84, 106, 110, 79, 25, -17, -45, -71, -89, -97, -127, -117, -70, -13, 36, 58, 53, 30, 45, 48, 31, 12, -21, -45, -54, -57, -53, -38, -5, 22, 40, 41, 33, 19, 1, -16, -28, -33, -27, -13, 1, 13, 16, 9, -5, -2, 16, 47, 83, 102, 101, 77, 33, -13, -59, -88, -127, -136, -125, -98, -56, 0, 59, 103, 145, 143, 113, 72, 29, -21, -60, -91, -129, -132, -109, -68, -15, 42, 82, 88, 84, 43, -11, -51, -65, -53, -27, 5, 14, 12, 7, 9, 18, 30, 39, 47, 64, 80, 79, 67, 17, -65, -135, -173, -154, -90, 0, 51, 67, 52, 34, 31, 45, 57, 44, 23, -15, -51, -97, -114, -111, -88, -43, -6, 31, 47, 62, 46, 21, 2, -9, -17, -27, -37, -42, -31, 2, 39, 67, 77, 70, 60, 70, 83, 85, 66, 28, -17, -50, -58, -79, -78, -74, -66, -54, -21, 27, 82, 145, 162, 128, 90, 35, -17, -54, -79, -95, -97, -72, -55, -15, 29, 62, 81, 88, 85, 64, 39, 10, -19, -34, -34, -21, -5, 6, 10, 10, 14, 25, 37, 41, 38, 21, 15, -4, -26, -54, -69, -71, -61, -32, -12, 19, 40, 59, 59, 51, 45, 38, 22, -5, -39, -88, -112, -109, -82, -41, 1, 32, 58, 98, 114, 95, 41, -23, -66, -63, -22, 10, 20, 6, -17, -26, -12, 13, 27, 27, 2, -27, -32, -23, -22, -41, -77, -118, -125, -95, -82, -57, -27, 11, 60, 113, 137, 116, 90, 39, -17, -55, -76, -81, -78, -62, -65, -48, -13, 33, 66, 80, 74, 51, 43, 28, 14, -25, -62, -93, -99, -76, -18, 46, 84, 86, 41, -18, -41, -26, 14, 31, 18, -15, -45, -60, -58, -42, -14, 17, 43, 64, 71, 58, 73, 69, 56, 32, 2, -42, -69, -72, -81, -54, -4, 47, 92, 123, 136, 122, 118, 84, 23, -38, -81, -88, -54, 1, 41, 53, 36, 4, -16, -15, 7, 29, 31, 12, -29, -49, -73, -98, -120, -114, -119, -86, -36, 8, 45, 83, 107, 116, 97, 58, 1, -51, -89, -115, -127, -123, -98, -59, -15, 23, 47, 68, 87, 96, 84, 48, 14, -22, -22, 3, 17, 23, 29, 33, 35, 42, 34, 19, 11, 6, -2, -20, -53, -106, -147, -151, -142, -104, -58, -23, 13, 58, 93, 98, 105, 76, 29, -22, -75, -126, -152, -140, -130, -90, -32, 22, 78, 129, 157, 149, 135, 86};
    volatile int16_t q_samples[SAMPLE_COUNT] = {303, 292, 232, 116, -5, -119, -217, -270, -283, -255, -197, -102, -2, 104, 213, 279, 301, 263, 182, 58, -61, -166, -248, -284, -277, -234, -158, -43, 71, 179, 271, 309, -3, -42, -62, -61, -53, -44, -39, -28, -12, 10, 32, 52, 59, 52, 28, 2, 279, 220, 134, 29, -42, -76, -72, -46, -11, 29, 63, 99, 125, 135, 119, 78, -269, -254, -190, -105, -50, -26, -19, -16, -6, 14, 32, 35, 66, 72, 62, 40, -10, -52, -76, -70, -80, -66, -40, -11, 18, 59, 85, 88, 104, 88, 46, -4, -34, -75, -80, -47, -23, 1, 16, 25, 31, 30, 18, -13, -53, -86, -102, -89, -72, -78, -107, -130, -132, -95, -28, 36, 95, 150, 177, 169, 116, 45, -28, -76, -101, -117, -118, -114, -93, -58, -8, 51, 100, 133, 139, 118, 67, 6, -55, -101, -119, -115, -97, -71, -35, 3, 33, 52, 44, 20, -1, -11, -12, -13, -12, -18, -17, -11, -25, -39, -47, -27, 14, 63, 86, 67, 64, 50, 34, 17, -16, -67, -105, -109, -111, -82, -40, 4, 48, 89, 110, 99, 93, 67, 33, 13, -15, -46, -71, -68, -52, -11, 32, 63, 67, 58, 45, 30, 13, -1, -8, -15, -20, -26, -29, -26, -17, -8, 13, 26, 55, 92, 114, 116, 86, 39, -13, -54, -80, -85, -106, -103, -82, -47, 4, 42, 73, 79, 99, 95, 83, 62, 38, 3, -22, -31, -50, -42, -27, -11, -4, -11, -28, -49, -54, -50, -37, -25, -15, -5, 1, 5, -9, -22, -21, -10, 22, 75, 112, 118, 132, 112, 73, 39, 0, -42, -77, -104, -125, -125, -96, -55, 3, 63, 89, 88, 64, 40, 6, -16, -56, -112, -165, -204, -209, -171, -99, -7, 61, 94, 105, 87, 56, 25, -7, -46, -72, -74, -47, -5, 38, 56, 59, 64, 78, 87, 109, 107, 88, 62, 28, -15, -55, -74, -97, -89, -60, -30, 0, 31, 51, 58, 82, 83, 60, 41, 10, -24, -46, -46, -59, -46, -14, -1, 17, 21, 13, -5, -17, -16, 2, 25, 40, 40, 26, 3, -21, -33, -35, -29, -12, 13, 42, 69, 83, 73, 36, 8, -26, -55, -76, -90, -87, -71, -35, -15, 10, 31, 72, 100, 117, 112, 91, 54, 12, -29, -75, -99, -100, -83, -54, -18, 11, 22, 43, 40, 22, 3, -22, -52, -71, -69, -57, -26, 11, 34, 46, 50, 50, 55, 65, 78, 70, 83, 66, 32, 1, -25, -69, -95, -94, -91, -53, 6, 54, 85, 95, 91, 69, 67, 39, -6, -53, -94, -124, -132, -108, -89, -51, -5, 16, 20, 14, 6, 2, -6, -15, -24, -46, -56, -59, -54, -50, -39, -23, 12, 62, 106, 131, 115, 78, 23, -22, -56, -99, -121, -118, -94, -64, -33, -4, 31, 86, 122, 131, 109, 68, 21, -16, -44, -71, -77, -60, -60, -41, -9, 24, 39, 57, 42, 9, -7, -26, -42, -51, -48, -26, 2, 31, 42, 48, 58, 71, 80, 81, 73, 53, 48, 33, 13, -8, -28, -42, -49, -39, -50, -36, -3, 34, 67, 93, 105, 90, 82, 52, 15, -13, -33, -65, -100, -124, -111, -55, 26, 103, 135, 114, 62, 6, -34, -46, -34, -22, -5, 10, 16, 12, 2, -8, -21, -13, 7, 37, 75, 90, 76, 36, -24, -89, -139, -155, -165, -128, -60, 5, 52, 77, 75, 47, 42, 24, -1, -30, -65, -107, -139, -135, -134, -92, -33, 17, 48, 55, 45, 20, 14, 0, -12, -27, -40, -59, -73, -70, -43, 7, 59, 90, 90, 71, 57, 55, 65, 66, 43, 8, -38, -86, -115, -122, -103, -77, -43, -5, 39, 93, 131, 145, 130, 95, 44, -14, -71, -107, -140, -125, -78, -22, 37, 85, 118};
    volatile int8_t ant[SAMPLE_COUNT] = {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -2, -2, -2, -2, -2, -2, -2, -2, 2, 2, 2, 2, 2, 2, 2, 2, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1};
    #ifdef OUTPUT

    // for(int i = 0; i < SAMPLE_COUNT; i++){
    //     print_uart0_int(i_samples[i]);
    // }

    // print_uart0("\n");

    // for(int i = 0; i < SAMPLE_COUNT; i++){
    //     print_uart0_int(q_samples[i]);
    // }

    // print_uart0("\n");
    // print_uart0("\n");

    #endif //OUTPUT

    predictive_decompress(i_samples, ant);
    predictive_decompress(q_samples, ant);

    return 0;
}

void *memcpy(void *dest, const void *src, size_t n){
    for (size_t i = 0; i < n; i++)
    {
        ((char*)dest)[i] = ((char*)src)[i];
    }
}

#ifdef OUTPUT

void print_uart0_int(int value) {
    char buffer[MAX_DIGITS];
    int i = MAX_DIGITS - 1;

    /* Handle 0 explicitely, otherwise empty string is printed for 0 */
    if (value == 0) {
        *UART0DR = '0';
        *UART0DR = ',';
        *UART0DR = ' ';
        return;
    }

    /* Handle negative numbers */
    if (value < 0) {
        *UART0DR = '-';
        value = -value;
    }

    /* Fill buffer from end */
    while (value > 0 && i >= 0) {
        buffer[i--] = (value % 10) + '0';
        value /= 10;
    }

    /* Output the number */
    while (++i < MAX_DIGITS)
        *UART0DR = buffer[i];

    *UART0DR = ',';
    *UART0DR = ' ';
    
}

void print_uart0(const char *s) {
    while(*s != '\0') { /* Loop until end of string */
        *UART0DR = (unsigned int)(*s); /* Transmit char */
        s++; /* Next char */
    }
}

#endif //OUTPUT

void predictive_decompress(volatile int16_t samples[], volatile int8_t ant[]){
    volatile int16_t dict_1[DICT_1_SIZE];
    volatile int16_t dict_2[DICT_2_SIZE];

    for(int i = 0; i < DICT_1_SIZE; i++){
        dict_1[i] = 0;
    }
    for(int i = 0; i < DICT_2_SIZE; i++){
        dict_2[i] = 0;
    }
    volatile int16_t result[SAMPLE_COUNT];

    uint8_t count1 = 0;
    uint8_t count2 = 0;

    for(int i = 0; i < SAMPLE_COUNT; i++){
        if(abs(ant[i]) == 1) {
            count2 = 0;

            result[i] =  dict_1[count1 % DICT_1_SIZE] + samples[i];
            dict_1[count1 % DICT_1_SIZE] = result[i];

            count1++;

        } else {
            count1 = 0;

            result[i] =  dict_2[count2 % DICT_2_SIZE] + samples[i];
            dict_2[count2 % DICT_2_SIZE] = result[i];

            count2++;
        }
    }

    #ifdef OUTPUT

    // for(int i = 0; i < SAMPLE_COUNT; i++){
    //     print_uart0_int(result[i]);
    // }

    // print_uart0("\n");
    // print_uart0("\n");

    #endif //OUTPUT
}
