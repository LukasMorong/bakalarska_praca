/*
 * Filename: decode.c
 * Author: Lukas Morong, xmoron01
 * Year: 2023
 * Description: 
 *     VLQ dekodovanie
 */

#include <stdint.h>
#include <stddef.h>
#include <stdlib.h>
#include <stdbool.h>


#include <stdio.h>


#define SUB_64 0
#define SUB_8192 1
#define SUB_1048576 2

// returns reqyuired aditional octets
// assumes that value will be < 1048576
unsigned int getRequiredAditional(unsigned int value) {
    if (value <= 63)
        return SUB_64;
    else if (value <= 8191)
        return SUB_8192;
    else
        return SUB_1048576;
}


#define SAMPLE_COUNT 624
#define MAX_DIGITS 10  /* Maximum digits for 32-bit integer plus null byte */

#define OUTPUT


volatile unsigned int * const UART0DR = (unsigned int *)0x101f1000;

void print_uart0(const char *s);
void print_uart0_int(int value);

void vlq_encode(volatile int16_t samples[]);
void vlq_decode(volatile int8_t data[], int count);


int c_entry(){
    //compressed
    volatile int8_t i_samples[1100] = {23, 192, 95, 193, 76, 194, 33, 194, 64, 194, 44, 193, 91, 192, 111, 29, 129, 17, 129, 107, 130, 35, 130, 40, 130, 6, 129, 57, 128, 91, 96, 193, 12, 193, 99, 194, 29, 194, 35, 194, 0, 193, 48, 192, 79, 50, 129, 33, 129, 119, 130, 33, 130, 18, 129, 90, 128, 127, 42, 113, 192, 123, 193, 65, 194, 4, 194, 36, 194, 28, 193, 92, 192, 120, 1, 129, 6, 129, 99, 130, 26, 130, 30, 129, 116, 129, 12, 16, 192, 107, 193, 65, 193, 71, 193, 3, 107, 33, 128, 80, 128, 94, 128, 94, 128, 87, 128, 73, 44, 10, 86, 110, 121, 192, 72, 192, 114, 193, 44, 193, 110, 194, 10, 193, 114, 193, 25, 105, 128, 75, 129, 56, 129, 118, 130, 11, 129, 112, 129, 46, 128, 66, 109, 193, 22, 193, 119, 194, 41, 194, 53, 194, 20, 193, 79, 192, 96, 17, 129, 0, 129, 96, 130, 15, 130, 18, 129, 96, 129, 12, 14, 192, 101, 193, 58, 193, 89, 193, 49, 192, 94, 10, 128, 79, 128, 119, 128, 125, 128, 122, 128, 114, 128, 97, 62, 2, 120, 192, 97, 192, 107, 192, 103, 192, 109, 193, 4, 193, 24, 193, 7, 192, 69, 29, 129, 15, 129, 92, 130, 13, 130, 19, 129, 114, 129, 34, 63, 106, 193, 22, 193, 100, 194, 31, 194, 49, 194, 22, 193, 60, 192, 74, 47, 129, 35, 129, 105, 130, 12, 130, 3, 129, 86, 128, 127, 24, 192, 90, 193, 83, 194, 26, 194, 32, 193, 88, 192, 100, 28, 128, 97, 128, 115, 128, 98, 128, 74, 49, 17, 78, 112, 192, 69, 192, 73, 127, 119, 124, 192, 85, 192, 103, 192, 84, 77, 128, 94, 129, 92, 130, 43, 130, 69, 130, 40, 129, 94, 128, 109, 1, 192, 103, 193, 73, 194, 7, 194, 29, 193, 121, 193, 42, 115, 54, 129, 17, 129, 97, 130, 12, 130, 22, 129, 110, 129, 30, 51, 192, 80, 193, 62, 194, 25, 194, 54, 194, 24, 193, 58, 192, 83, 11, 128, 82, 128, 112, 128, 113, 128, 88, 43, 87, 192, 80, 192, 119, 192, 127, 192, 103, 127, 102, 96, 97, 83, 22, 128, 97, 129, 45, 129, 117, 130, 26, 130, 24, 129, 97, 129, 5, 12, 192, 126, 193, 92, 194, 15, 194, 20, 193, 121, 193, 63, 192, 117, 85, 128, 99, 129, 65, 130, 0, 130, 24, 130, 1, 129, 65, 128, 104, 70, 193, 5, 193, 100, 194, 30, 194, 32, 193, 112, 193, 17, 114, 30, 128, 83, 128, 96, 128, 85, 55, 16, 100, 192, 79, 192, 106, 192, 111, 192, 94, 192, 68, 104, 80, 14, 128, 64, 128, 124, 129, 70, 129, 122, 130, 22, 130, 13, 129, 93, 129, 9, 6, 192, 124, 193, 123, 194, 62, 194, 71, 194, 20, 193, 62, 192, 88, 28, 128, 122, 129, 84, 130, 9, 130, 29, 130, 3, 129, 69, 128, 102, 89, 193, 10, 193, 114, 194, 40, 194, 45, 193, 118, 193, 30, 121, 34, 128, 73, 128, 72, 45, 20, 2, 75, 95, 192, 65, 192, 94, 192, 104, 192, 85, 114, 74, 23, 61, 129, 0, 129, 76, 130, 21, 130, 61, 130, 39, 129, 76, 128, 86, 100, 193, 20, 193, 86, 193, 123, 194, 11, 194, 4, 193, 96, 193, 28, 121, 128, 73, 129, 51, 130, 0, 130, 32, 130, 14, 129, 80, 128, 100, 76, 193, 8, 193, 98, 194, 29, 194, 46, 194, 14, 193, 71, 192, 96, 75, 55, 128, 75, 63, 28, 71, 99, 117, 126, 127, 119, 101, 72, 20, 50, 128, 93, 129, 16, 129, 85, 130, 14, 130, 49, 130, 44, 129, 117, 129, 18, 7, 192, 114, 193, 94, 194, 24, 194, 49, 194, 32, 193, 105, 193, 14, 75, 128, 105, 129, 73, 130, 13, 130, 35, 130, 15, 129, 88, 129, 1, 5, 192, 109, 193, 80, 194, 25, 194, 44, 194, 17, 193, 80, 192, 118, 72, 128, 74, 128, 119, 128, 114, 128, 73, 9, 105, 192, 69, 192, 74, 192, 67, 121, 109, 91, 6, 45, 128, 87, 129, 6, 129, 54, 129, 106, 130, 29, 130, 45, 130, 18, 129, 63, 128, 77, 192, 64, 193, 47, 193, 126, 194, 36, 194, 30, 193, 120, 193, 46, 192, 83, 40, 129, 22, 129, 111, 130, 35, 130, 30, 129, 104, 129, 0, 17, 192, 104, 193, 63, 193, 121, 194, 24, 194, 12, 193, 87, 192, 110, 68, 128, 87, 128, 115, 128, 96, 48, 10, 77, 95, 113, 192, 68, 192, 84, 192, 83, 121, 78, 33, 128, 72, 128, 89, 128, 107, 129, 22, 129, 83, 130, 7, 130, 4, 129, 69, 128, 73, 112, 193, 31, 194, 1, 194, 55, 194, 63, 194, 19, 193, 60, 125, 54, 129, 28, 129, 112, 130, 22, 130, 18, 129, 103, 129, 28, 47, 125, 193, 38, 194, 0, 194, 41, 194, 37, 193, 107, 193, 21, 94, 128, 70, 129, 10, 129, 30, 128, 124, 62, 79, 192, 75, 192, 124, 193, 20, 193, 16, 192, 102, 101, 27, 128, 72, 128, 74, 54, 48, 128, 81, 129, 36, 129, 114, 130, 25, 129, 117, 129, 24, 13, 192, 106, 193, 73, 194, 15, 194, 38, 194, 20, 193, 83, 192, 117, 67, 128, 127, 129, 97, 130, 40, 130, 54, 130, 20, 129, 61, 128, 87, 89, 193, 14, 193, 92, 194, 4, 193, 122, 193, 73, 192, 112, 77, 128, 92, 129, 60, 129, 94, 129, 53, 128, 86, 83, 192, 103, 193, 1, 192, 123, 192, 107, 192, 91, 192, 66, 97, 11, 57, 128, 81, 128, 83, 128, 79, 128, 93, 129, 7, 129, 65, 129, 80, 129, 19, 32, 192, 101, 193, 97, 194, 31, 194, 51, 194, 30, 193, 103, 193, 0, 74, 128, 113, 129, 96, 130, 27, 130, 41, 130, 3, 129, 59, 128, 74, 104, 193, 20, 193, 112, 194, 23, 194, 19, 193, 99, 193, 26, 108, 128, 74, 129, 60, 130, 16, 130, 14, 129, 67, 128, 64, 105, 192, 100, 192, 112, 192, 100, 192, 78, 122, 95, 9, 45, 128, 76, 128, 92, 128, 89, 128, 77, 128, 73, 128, 82, 128, 87, 61, 68, 192, 110, 193, 77, 194, 27, 194, 54, 194, 38, 193, 100, 193, 10, 94, 128, 95, 129, 61, 129, 125, 130, 5, 129, 94, 129, 5, 35, 192, 66, 193, 42, 193, 110, 194, 16, 194, 1, 193, 69, 192, 98, 3, 128, 105, 129, 81, 130, 18};
    volatile int8_t q_samples[1094] = {130, 47, 130, 36, 129, 104, 128, 116, 69, 192, 119, 193, 89, 194, 14, 194, 27, 193, 127, 193, 69, 192, 102, 66, 128, 104, 129, 85, 130, 23, 130, 45, 130, 7, 129, 54, 58, 125, 193, 38, 193, 120, 194, 28, 194, 21, 193, 106, 193, 30, 107, 128, 71, 129, 51, 130, 15, 130, 53, 130, 44, 129, 122, 129, 42, 55, 122, 193, 35, 194, 0, 194, 42, 194, 39, 193, 117, 193, 37, 114, 57, 129, 28, 129, 113, 130, 25, 130, 23, 129, 92, 129, 6, 29, 106, 192, 76, 192, 72, 110, 75, 29, 63, 128, 99, 128, 125, 129, 7, 128, 119, 128, 78, 31, 68, 84, 114, 192, 108, 193, 61, 194, 19, 194, 58, 194, 45, 193, 103, 193, 5, 79, 128, 123, 129, 100, 130, 47, 130, 65, 130, 35, 129, 83, 128, 106, 76, 193, 13, 193, 104, 194, 32, 194, 39, 194, 3, 193, 47, 192, 73, 45, 129, 47, 130, 11, 130, 61, 130, 49, 129, 117, 129, 17, 54, 82, 192, 65, 192, 75, 120, 85, 20, 59, 128, 81, 128, 86, 128, 72, 49, 17, 75, 105, 192, 82, 192, 127, 193, 52, 193, 112, 194, 28, 194, 47, 194, 22, 193, 78, 192, 81, 44, 129, 26, 129, 111, 130, 17, 130, 19, 129, 117, 129, 62, 128, 94, 76, 192, 126, 193, 106, 194, 34, 194, 40, 193, 116, 193, 31, 106, 128, 66, 129, 35, 129, 114, 130, 17, 130, 6, 129, 76, 128, 126, 30, 107, 192, 89, 192, 100, 192, 72, 87, 31, 128, 64, 128, 79, 128, 80, 128, 75, 60, 36, 5, 93, 122, 192, 93, 193, 24, 193, 91, 194, 31, 194, 55, 194, 33, 193, 87, 192, 120, 78, 128, 108, 129, 76, 130, 17, 130, 34, 130, 3, 129, 50, 128, 85, 79, 192, 123, 193, 80, 194, 18, 194, 30, 193, 120, 193, 27, 113, 57, 129, 31, 129, 102, 130, 19, 130, 30, 129, 119, 129, 30, 55, 102, 192, 95, 192, 100, 192, 68, 73, 44, 128, 89, 128, 109, 128, 109, 128, 93, 128, 74, 52, 21, 79, 119, 192, 87, 192, 119, 193, 41, 193, 99, 194, 18, 194, 29, 193, 106, 192, 123, 70, 128, 102, 129, 66, 129, 115, 130, 4, 129, 108, 129, 51, 128, 93, 85, 192, 118, 193, 77, 193, 127, 194, 14, 193, 116, 193, 47, 192, 76, 50, 129, 24, 129, 114, 130, 36, 130, 57, 130, 33, 129, 97, 128, 127, 5, 192, 80, 192, 122, 192, 111, 192, 72, 84, 16, 40, 55, 59, 56, 49, 37, 16, 78, 114, 192, 96, 193, 13, 193, 62, 193, 109, 193, 124, 193, 82, 192, 122, 69, 128, 126, 129, 86, 130, 11, 130, 26, 130, 4, 129, 66, 128, 102, 75, 193, 18, 193, 115, 194, 45, 194, 54, 194, 11, 193, 53, 192, 86, 12, 128, 114, 129, 64, 129, 120, 130, 20, 130, 1, 129, 49, 60, 192, 77, 193, 76, 193, 123, 193, 93, 192, 118, 75, 128, 74, 128, 121, 128, 127, 128, 111, 128, 84, 49, 3, 99, 122, 125, 119, 122, 192, 85, 193, 3, 193, 45, 193, 46, 192, 123, 77, 128, 102, 129, 86, 130, 20, 130, 39, 130, 11, 129, 77, 128, 120, 5, 192, 100, 193, 78, 194, 17, 194, 45, 194, 23, 193, 88, 192, 123, 68, 128, 95, 129, 46, 129, 105, 130, 2, 129, 124, 129, 83, 129, 3, 1, 192, 123, 193, 90, 193, 124, 193, 76, 192, 97, 2, 128, 69, 128, 104, 128, 111, 128, 113, 128, 109, 128, 89, 43, 73, 119, 192, 82, 192, 88, 192, 93, 192, 114, 193, 15, 193, 32, 193, 4, 118, 128, 70, 129, 47, 129, 122, 130, 28, 130, 13, 129, 84, 129, 1, 30, 192, 82, 193, 43, 193, 113, 194, 32, 194, 35, 193, 120, 193, 16, 87, 128, 113, 129, 79, 130, 9, 130, 31, 130, 14, 129, 95, 129, 8, 32, 192, 99, 193, 78, 194, 16, 194, 14, 193, 65, 192, 75, 45, 128, 109, 128, 126, 128, 114, 128, 91, 57, 18, 90, 192, 66, 192, 81, 192, 71, 118, 111, 192, 64, 192, 93, 192, 105, 192, 67, 24, 129, 12, 130, 2, 130, 60, 130, 60, 130, 14, 129, 59, 60, 192, 65, 193, 48, 194, 6, 194, 38, 194, 26, 193, 109, 193, 35, 113, 128, 68, 129, 54, 130, 18, 130, 48, 130, 25, 129, 89, 129, 1, 12, 192, 100, 193, 79, 194, 39, 194, 67, 194, 19, 193, 49, 119, 59, 128, 115, 129, 0, 128, 108, 128, 76, 33, 92, 192, 82, 192, 125, 193, 7, 192, 121, 192, 93, 192, 70, 116, 95, 1, 128, 64, 129, 11, 129, 90, 130, 25, 130, 38, 130, 4, 129, 43, 128, 66, 122, 193, 31, 193, 112, 194, 39, 194, 42, 193, 123, 193, 23, 105, 128, 82, 129, 49, 129, 122, 130, 39, 130, 32, 129, 109, 129, 18, 52, 112, 193, 32, 193, 120, 194, 48, 194, 43, 193, 108, 192, 120, 77, 128, 68, 128, 108, 128, 102, 128, 66, 25, 79, 118, 192, 80, 192, 94, 192, 93, 192, 73, 99, 1, 28, 50, 128, 74, 128, 117, 129, 59, 129, 123, 130, 38, 130, 30, 129, 104, 129, 1, 17, 192, 97, 193, 81, 194, 20, 194, 42, 194, 8, 193, 56, 122, 128, 64, 129, 44, 130, 3, 130, 46, 130, 54, 130, 19, 129, 76, 128, 81, 112, 193, 44, 194, 15, 194, 47, 194, 22, 193, 68, 192, 101, 70, 49, 128, 74, 128, 74, 56, 32, 3, 84, 108, 192, 64, 192, 82, 192, 91, 192, 81, 120, 76, 35, 128, 87, 129, 21, 129, 79, 130, 7, 130, 31, 130, 14, 129, 69, 128, 93, 90, 193, 20, 193, 97, 194, 13, 194, 15, 193, 118, 193, 59, 192, 109, 75, 128, 106, 129, 68, 130, 2, 130, 16, 129, 117, 129, 40, 128, 65, 118, 193, 54, 194, 8, 194, 48, 194, 30, 193, 102, 193, 13, 120, 14, 63, 128, 74, 62, 29, 72, 120, 192, 93, 192, 114, 192, 107, 192, 75, 96, 9, 34, 59, 128, 92, 129, 14, 129, 86, 130, 17, 130, 50, 130, 39, 129, 104, 128, 111, 86, 193, 20, 193, 123, 194, 46, 194, 56, 194, 20, 193, 79, 192, 94, 22, 129, 6, 129, 108, 130, 35, 130, 46, 130, 2, 129, 46, 61, 192, 75, 193, 51, 194, 4, 194, 30, 194, 11, 193, 73, 192, 112};
    

    #ifdef OUTPUT

    // for(int i = 0; i < SAMPLE_COUNT; i++){
    //     print_uart0_int(i_samples[i]);
    // }

    // print_uart0("\n");

    // for(int i = 0; i < SAMPLE_COUNT; i++){
    //     print_uart0_int(q_samples[i]);
    //     print_uart0("\n");
    // }

    // print_uart0("\n");
    // print_uart0("\n");

    #endif //OUTPUT


    vlq_decode(i_samples, 1100);
    print_uart0("\n");
    vlq_decode(q_samples, 1094);
    print_uart0("\n");

    return 0;
}

void *memcpy(void *dest, const void *src, size_t n){
    for (size_t i = 0; i < n; i++)
    {
        ((char*)dest)[i] = ((char*)src)[i];
    }
}

#ifdef OUTPUT

void print_uart0_int(int value) {
    char buffer[MAX_DIGITS];
    int i = MAX_DIGITS - 1;

    /* Handle 0 explicitely, otherwise empty string is printed for 0 */
    if (value == 0) {
        *UART0DR = '0';
        // *UART0DR = ',';
        // *UART0DR = ' ';
        return;
    }

    /* Handle negative numbers */
    if (value < 0) {
        *UART0DR = '-';
        value = -value;
    }

    /* Fill buffer from end */
    while (value > 0 && i >= 0) {
        buffer[i--] = (value % 10) + '0';
        value /= 10;
    }

    /* Output the number */
    while (++i < MAX_DIGITS)
        *UART0DR = buffer[i];

    // *UART0DR = ',';
    // *UART0DR = ' ';
    
}

void print_uart0(const char *s) {
    while(*s != '\0') { /* Loop until end of string */
        *UART0DR = (unsigned int)(*s); /* Transmit char */
        s++; /* Next char */
    }
}

#endif //OUTPUT


#define MAX_LEN (SAMPLE_COUNT * 16)
#define VLQ_OCTET_BITS 8
#define VLQ_DATA_BITS_FIRST 6
#define VLQ_DATA_BITS_NEXT 7
#define VLQ_CONTINUE_MASK (1 << 7)
#define VLQ_SIGN_MASK (1 << 6)

void vlq_encode(volatile int16_t samples[]) {
    uint8_t output[MAX_LEN];
    int count = 0;

    for (int16_t i = 0; i < SAMPLE_COUNT; ++i) {
        int16_t number = samples[i];
        int16_t abs_num = abs(number);

        int8_t aditional = getRequiredAditional(abs_num);

        uint8_t octet = (abs_num >> (VLQ_DATA_BITS_NEXT * aditional)) & ((1 << VLQ_DATA_BITS_FIRST) - 1);

        if (number < 0) { // if the number is negative
            octet |= VLQ_SIGN_MASK; // set the sign bit
        }

        if(aditional){
            octet |= VLQ_CONTINUE_MASK;
        }

        // add octet to the beginning of the output array
        output[count++] = octet;

        while(aditional--){

            octet = (abs_num >> (VLQ_DATA_BITS_NEXT * aditional)) & ((1 << VLQ_DATA_BITS_NEXT) - 1);

            if(aditional){
                octet |= VLQ_CONTINUE_MASK;
            }

            output[count++] = octet;

        }
    }

    print_uart0("count: ");
    print_uart0_int(count);
    print_uart0("\n");
    for(int i = 0; i < count; i++){
        print_uart0_int(output[i]);
        print_uart0(", ");
    }

}


void vlq_decode(volatile int8_t data[], int encoded_count){
    int16_t result[SAMPLE_COUNT];
    int count = 0;

    for(int16_t i = 0; i < encoded_count; i++){
        int8_t octet = data[i];
        bool negative = octet & VLQ_SIGN_MASK;
        int16_t number = octet & ((1 << VLQ_DATA_BITS_FIRST) - 1);

        while(octet & VLQ_CONTINUE_MASK){
            if(i >= encoded_count) break;

            octet = data[++i];
            number = (number << VLQ_DATA_BITS_NEXT) | (octet & ((1 << VLQ_DATA_BITS_NEXT) - 1));
        }

        if(negative){
            number *= -1;
        }

        result[count++] = number; 
    }

    for(int i = 0; i < count; i++){
        print_uart0_int(result[i]);
        print_uart0(", ");
    }
}


